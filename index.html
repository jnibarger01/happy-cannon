<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <title>Jace Pay Calculator – Hendrick Toyota Merriam</title>
  <style>
    :root{
      --bg:#0b0f14; --card:#111824; --muted:#9fb0c3; --text:#e9f1fb;
      --accent:#4aa3ff; --good:#2dd4bf; --warn:#fbbf24; --bad:#fb7185;
      --border:#1f2a3a; --chip:#0f1723;
      --hendrick-red: #cc0000;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{margin:0; background:linear-gradient(180deg, #070a0f, #0b0f14 40%); color:var(--text); font-family:var(--sans);}
    header{position:sticky; top:0; z-index:20; backdrop-filter: blur(10px);
      background:rgba(11,15,20,.85); border-bottom:1px solid var(--border);}
    .wrap{max-width:1200px; margin:0 auto; padding:16px;}
    .header-row{display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px;}
    h1{font-size:18px; margin:0; letter-spacing:.2px}
    .dealer-badge{background:var(--hendrick-red); color:white; padding:4px 10px; border-radius:6px; font-size:11px; font-weight:600; letter-spacing:.5px;}
    .sub{color:var(--muted); font-size:12px; margin-top:6px}
    nav{display:flex; gap:8px; flex-wrap:wrap; margin-top:12px}
    .tab{border:1px solid var(--border); background:var(--chip); color:var(--text);
      padding:8px 10px; border-radius:10px; cursor:pointer; font-size:13px;}
    .tab.active{border-color:rgba(74,163,255,.7); box-shadow:0 0 0 2px rgba(74,163,255,.15) inset;}
    .grid{display:grid; grid-template-columns: 1.2fr .8fr; gap:14px; align-items:start;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr;} }
    .card{background:rgba(17,24,36,.9); border:1px solid var(--border); border-radius:14px; padding:14px;}
    .card h2{font-size:14px; margin:0 0 10px 0; color:#dce8f7;}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    @media (max-width: 680px){ .row{grid-template-columns:1fr;} }
    label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px}
    input, select, textarea{
      width:100%; padding:10px; border-radius:10px;
      border:1px solid var(--border); background:#0b1220; color:var(--text);
      outline:none; font-family:var(--sans); font-size:16px;
    }
    input:focus, textarea:focus{border-color:rgba(74,163,255,.7); box-shadow:0 0 0 3px rgba(74,163,255,.15);}
    .btn{
      border:1px solid var(--border); background:#0b1220; color:var(--text);
      padding:9px 10px; border-radius:10px; cursor:pointer; font-size:13px;
      transition: transform 0.1s, opacity 0.1s;
    }
    .btn.primary{border-color:rgba(74,163,255,.6); background:rgba(74,163,255,.12);}
    .btn.good{border-color:rgba(45,212,191,.6); background:rgba(45,212,191,.12);}
    .btn.warn{border-color:rgba(251,191,36,.6); background:rgba(251,191,36,.10);}
    .btn.bad{border-color:rgba(251,113,133,.6); background:rgba(251,113,133,.10);}
    .btn.large{padding:14px 18px; font-size:15px; font-weight:600;}
    .btn:active{transform:translateY(1px)}
    .btn:disabled{opacity:0.5; cursor:not-allowed;}
    .muted{color:var(--muted); font-size:12px; line-height:1.4}
    .kpis{display:grid; grid-template-columns:repeat(3, 1fr); gap:10px;}
    @media (max-width: 980px){ .kpis{grid-template-columns:repeat(2, 1fr);} }
    @media (max-width: 520px){ .kpis{grid-template-columns:1fr;} }
    .kpi{background:#0b1220; border:1px solid var(--border); border-radius:12px; padding:10px;}
    .kpi .t{font-size:11px; color:var(--muted); margin-bottom:8px;}
    .kpi .v{font-size:18px; font-family:var(--mono);}
    .kpi .d{font-size:11px; color:var(--muted); margin-top:6px;}
    .kpi.highlight{border-color:var(--good); background:rgba(45,212,191,.08);}
    .kpi.highlight .v{color:var(--good);}
    .flex{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .spacer{height:8px}
    .spacer-lg{height:16px}
    .hide{display:none !important}
    .twoCol{display:grid; grid-template-columns: 1fr 1fr; gap:12px;}
    @media (max-width: 980px){ .twoCol{grid-template-columns:1fr;} }
    footer{padding:18px 0 30px; color:var(--muted); font-size:12px;}
    .small{font-size:11px; color:var(--muted);}
    .dangerNote{border-left:3px solid rgba(251,113,133,.75); padding-left:10px;}
    .goodNote{border-left:3px solid rgba(45,212,191,.75); padding-left:10px;}

    /* Goals Progress */
    .goal-bar{background:#0b1220; border-radius:8px; height:24px; overflow:hidden; position:relative; border:1px solid var(--border);}
    .goal-fill{height:100%; background:linear-gradient(90deg, var(--good), var(--accent)); transition: width 0.4s ease;}
    .goal-text{position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:11px; font-weight:600; color:white; text-shadow:0 1px 2px rgba(0,0,0,.5);}

    /* Month selector */
    .month-selector{display:flex; gap:6px; margin-bottom:12px; flex-wrap:wrap;}
    .month-btn{background:var(--chip); border:1px solid var(--border); color:var(--muted); padding:6px 12px; border-radius:8px; cursor:pointer; font-size:12px;}
    .month-btn.active{background:rgba(74,163,255,.12); border-color:var(--accent); color:var(--accent);}
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="header-row">
      <div>
        <h1>Jace Pay Calculator</h1>
        <div class="sub">Monthly Commission Calculator</div>
      </div>
      <span class="dealer-badge">HENDRICK TOYOTA MERRIAM</span>
    </div>
    <nav id="tabs"></nav>
  </div>
</header>

<main class="wrap">
  <!-- TAB: MONTHLY COMMISSIONS -->
  <section class="tabPage" data-page="commissions">
    <div class="grid">
      <div class="card">
        <h2>Select Month</h2>
        <div class="row">
          <div>
            <label>Month</label>
            <input id="currentMonth" type="month" />
          </div>
          <div class="flex" style="align-items:flex-end;">
            <button class="btn primary" id="loadMonth">Load Month</button>
            <button class="btn" id="newMonth">New Month</button>
          </div>
        </div>

        <div class="spacer-lg"></div>

        <h2>Monthly Sales Totals</h2>

        <div class="row">
          <div>
            <label>Customer Pay (CP) Labor $</label>
            <input id="cpLabor" type="number" min="0" step="0.01" value="0" inputmode="decimal" />
          </div>
          <div>
            <label>Customer Pay (CP) Parts $</label>
            <input id="cpParts" type="number" min="0" step="0.01" value="0" inputmode="decimal" />
          </div>
        </div>

        <div class="spacer"></div>

        <div class="row">
          <div>
            <label>Warranty Labor $</label>
            <input id="wLabor" type="number" min="0" step="0.01" value="0" inputmode="decimal" />
          </div>
          <div>
            <label>Warranty Parts $</label>
            <input id="wParts" type="number" min="0" step="0.01" value="0" inputmode="decimal" />
          </div>
        </div>

        <div class="spacer"></div>

        <div class="row">
          <div>
            <label>Internal Labor $</label>
            <input id="iLabor" type="number" min="0" step="0.01" value="0" inputmode="decimal" />
          </div>
          <div>
            <label>Internal Parts $</label>
            <input id="iParts" type="number" min="0" step="0.01" value="0" inputmode="decimal" />
          </div>
        </div>

        <div class="spacer"></div>

        <div class="row">
          <div>
            <label>Sublet Labor $</label>
            <input id="subletLabor" type="number" min="0" step="0.01" value="0" inputmode="decimal" />
          </div>
          <div>
            <label>Discounts $</label>
            <input id="discounts" type="number" min="0" step="0.01" value="0" inputmode="decimal" />
          </div>
        </div>

        <div class="spacer"></div>

        <div class="row">
          <div>
            <label>Hours Sold</label>
            <input id="hoursSold" type="number" min="0" step="0.1" value="0" inputmode="decimal" />
          </div>
        </div>

        <div class="spacer"></div>

        <div class="flex">
          <button class="btn primary large" id="saveMonth">Save Month</button>
          <button class="btn" id="clearMonth">Clear</button>
          <span class="pill" style="display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; border:1px solid var(--border); background:#0f1723; font-size:11px; color:var(--muted);"><span class="dot good" style="width:8px; height:8px; border-radius:99px; background:var(--good);"></span>Autosaves</span>
        </div>

        <div class="spacer"></div>

        <div class="muted dangerNote">
          <strong>Rates:</strong> 7% CP (labor+parts−discounts) | 5% Warranty | 5% Internal | 0.5% Sublet
        </div>

        <div class="spacer-lg"></div>

        <!-- Saved Months -->
        <h2>Saved Months</h2>
        <div id="monthsList" class="muted"></div>
      </div>

      <div class="card">
        <h2>Monthly Commission Summary</h2>

        <!-- Goal Progress -->
        <div style="margin-bottom:16px;">
          <div class="flex" style="justify-content:space-between; margin-bottom:6px;">
            <span class="small">Monthly CP Net Goal: $90,000</span>
            <span class="small" id="goalPctText">0%</span>
          </div>
          <div class="goal-bar">
            <div class="goal-fill" id="goalFill" style="width:0%"></div>
            <span class="goal-text" id="goalText">$0 / $90,000</span>
          </div>
        </div>

        <div class="kpis">
          <div class="kpi highlight"><div class="t">Total Commission</div><div class="v" id="kpiCommission">$0.00</div><div class="d">This month</div></div>
          <div class="kpi"><div class="t">CP Net Sales</div><div class="v" id="kpiCpNet">$0.00</div><div class="d">Labor + parts − discounts</div></div>
          <div class="kpi"><div class="t">Warranty Sales</div><div class="v" id="kpiW">$0.00</div><div class="d">Labor + parts</div></div>
          <div class="kpi"><div class="t">Internal Sales</div><div class="v" id="kpiI">$0.00</div><div class="d">Labor + parts</div></div>
          <div class="kpi"><div class="t">Sublet Labor</div><div class="v" id="kpiSublet">$0.00</div><div class="d">Labor only</div></div>
          <div class="kpi"><div class="t">Hours Sold</div><div class="v" id="kpiHours">0.0</div><div class="d">Total hours</div></div>
        </div>

        <div class="spacer"></div>

        <div class="card" style="padding:12px; margin:0;">
          <h2 style="margin-bottom:8px;">Commission Breakdown</h2>
          <div class="muted" id="breakdownText"></div>
        </div>

        <div class="spacer"></div>

        <div class="flex">
          <button class="btn good" id="exportData">Export</button>
          <button class="btn primary" id="importData">Import</button>
          <button class="btn bad" id="deleteMonth">Delete Month</button>
        </div>
        <input type="file" id="importFile" accept=".json" style="display:none" />
      </div>
    </div>
  </section>

  <!-- TAB: MONTHLY BONUSES -->
  <section class="tabPage hide" data-page="bonuses">
    <div class="grid">
      <div class="card">
        <h2>Monthly Bonus Inputs</h2>

        <div class="row">
          <div>
            <label>Month</label>
            <input id="monthLabel" placeholder="e.g., Jan 2026" />
          </div>
          <div>
            <label>CP Net (Labor+Parts − Discounts)</label>
            <input id="monthlyCpNet" type="number" min="0" step="0.01" value="0" inputmode="decimal" />
          </div>
        </div>

        <div class="spacer"></div>

        <div class="row">
          <div>
            <label>Google Reviews This Month</label>
            <input id="reviewsCount" type="number" min="0" step="1" value="0" inputmode="numeric" />
          </div>
          <div>
            <label>Tier Bonus Eligibility</label>
            <select id="tierEligible">
              <option value="auto">Auto (7+ reviews required)</option>
              <option value="yes">Yes (force eligible)</option>
              <option value="no">No (force ineligible)</option>
            </select>
          </div>
        </div>

        <div class="spacer"></div>

        <div class="card" style="margin:0; padding:12px;">
          <h2 style="margin-bottom:8px;">Objective Bonus Inputs</h2>

          <div class="row">
            <div>
              <label>CP + Warranty Net (objective base)</label>
              <input id="objBase" type="number" min="0" step="0.01" value="0" inputmode="decimal" />
            </div>
            <div>
              <label>Objective Bonus Mode</label>
              <select id="objMode">
                <option value="weighted">Weighted by objectives met</option>
                <option value="manual">Manual percent (override)</option>
              </select>
            </div>
          </div>

          <div class="spacer"></div>

          <div id="objWeighted">
            <div class="row">
              <div><label><input type="checkbox" id="objAlign" /> Alignments (0.2%)</label></div>
              <div><label><input type="checkbox" id="objTotLaborGross" /> Total labor gross (0.3%)</label></div>
            </div>
            <div class="row">
              <div><label><input type="checkbox" id="objCpLaborGross" /> CP labor gross (0.2%)</label></div>
              <div><label><input type="checkbox" id="objHag" /> HAG products (0.1%)</label></div>
            </div>
            <div class="row">
              <div><label><input type="checkbox" id="objCpGrossPerRo" /> CP labor gross/RO (0.1%)</label></div>
              <div><label><input type="checkbox" id="objHoursPerCpro" /> Hours per CP RO (0.1%)</label></div>
            </div>
          </div>

          <div id="objManual" class="hide">
            <label>Manual Objective Bonus % (0.0 to 1.0)</label>
            <input id="objManualPct" type="number" min="0" max="1" step="0.001" value="0" inputmode="decimal" />
          </div>
        </div>

        <div class="spacer"></div>

        <div class="flex">
          <button class="btn primary" id="saveMonthlyBonus">Save Monthly Inputs</button>
          <button class="btn" id="resetMonthly">Reset</button>
        </div>
      </div>

      <div class="card">
        <h2>Monthly Bonus Results</h2>

        <div class="kpis">
          <div class="kpi"><div class="t">Tier Bonus %</div><div class="v" id="kpiTierPct">0.0%</div></div>
          <div class="kpi"><div class="t">Tier Bonus $</div><div class="v" id="kpiTierDollars">$0.00</div></div>
          <div class="kpi"><div class="t">Objective Bonus %</div><div class="v" id="kpiObjPct">0.0%</div></div>
          <div class="kpi"><div class="t">Objective Bonus $</div><div class="v" id="kpiObjDollars">$0.00</div></div>
          <div class="kpi"><div class="t">Review Bonus</div><div class="v" id="kpiReviewBonus">$0.00</div></div>
          <div class="kpi highlight"><div class="t">Total Monthly Bonus</div><div class="v" id="kpiTotalMonthly">$0.00</div></div>
        </div>

        <div class="spacer"></div>

        <div class="card" style="margin:0; padding:12px;">
          <h2 style="margin-bottom:8px;">Bonus Requirements</h2>
          <div id="monthlyStatus" class="muted"></div>
        </div>

        <div class="spacer"></div>

        <!-- Tier Breakdown -->
        <div class="card" style="margin:0; padding:12px;">
          <h2 style="margin-bottom:8px;">Tier Levels</h2>
          <div class="muted">
            <div id="tierBreakdown"></div>
          </div>
        </div>

        <div class="spacer"></div>

        <div class="flex">
          <button class="btn bad" id="wipeAll">Wipe ALL Data</button>
        </div>
      </div>
    </div>
  </section>

  <footer>
    <div class="flex" style="justify-content:space-between; flex-wrap:wrap; gap:10px;">
      <span>Hendrick Toyota Merriam | Service Advisor Pay Calculator</span>
      <span>Data stored locally on this device only</span>
    </div>
  </footer>
</main>

<script>
/* ============
   CORE: CALCULATOR
============ */
const Calculator = {
  rates: {
    cp: 0.07,
    w: 0.05,
    i: 0.05,
    sublet: 0.005,
  },

  tierLevels: [
    { threshold: 35000, addPct: 0.005, label: '$35K' },
    { threshold: 45000, addPct: 0.005, label: '$45K' },
    { threshold: 55000, addPct: 0.005, label: '$55K' },
    { threshold: 65000, addPct: 0.005, label: '$65K' },
  ],

  monthlyGoal: 90000,

  objWeights: {
    align: 0.002,
    totLaborGross: 0.003,
    cpLaborGross: 0.002,
    hag: 0.001,
    cpGrossPerRo: 0.001,
    hoursPerCpro: 0.001,
  },

  calcMonthlyCommission(data) {
    const cpNet = Math.max(0, data.cpLabor + data.cpParts - data.discounts);
    const wSales = data.wLabor + data.wParts;
    const iSales = data.iLabor + data.iParts;
    const subletSales = data.subletLabor;

    const commission =
      cpNet * this.rates.cp +
      wSales * this.rates.w +
      iSales * this.rates.i +
      subletSales * this.rates.sublet;

    const total = cpNet + wSales + iSales + subletSales;

    return { cpNet, wSales, iSales, subletSales, commission, total };
  },

  calcTierBonus(cpNet, eligible) {
    if (!eligible) return { pct: 0, dollars: 0, tiersHit: [] };
    let pct = 0;
    const tiersHit = [];
    for (const lvl of this.tierLevels) {
      if (cpNet >= lvl.threshold) {
        pct += lvl.addPct;
        tiersHit.push(lvl.label);
      }
    }
    return { pct, dollars: cpNet * pct, tiersHit };
  },

  calcObjectiveBonus(mode, base, checks, manualPct) {
    let pct = 0;
    if (mode === "manual") {
      pct = Math.max(0, Math.min(0.01, manualPct));
    } else {
      Object.entries(checks).forEach(([key, val]) => {
        if (val && this.objWeights[key]) pct += this.objWeights[key];
      });
      pct = Math.max(0, Math.min(0.01, pct));
    }
    return { pct, dollars: base * pct };
  },

  calcReviewBonus(count) {
    return count >= 15 ? 375 : 0;
  },

  calcMonthlyBonus(bonusData) {
    const eligible =
      bonusData.tierEligible === "yes"
        ? true
        : bonusData.tierEligible === "no"
        ? false
        : bonusData.reviewsCount >= 7;

    const tier = this.calcTierBonus(bonusData.monthlyCpNet, eligible);
    const obj = this.calcObjectiveBonus(
      bonusData.objMode,
      bonusData.objBase,
      bonusData.objChecks,
      bonusData.objManualPct
    );
    const review = this.calcReviewBonus(bonusData.reviewsCount);

    return {
      tier,
      obj,
      review,
      total: tier.dollars + obj.dollars + review,
      eligible,
    };
  },
};

/* ============
   CORE: STORAGE
============ */
const Storage = {
  KEY: "hendrick_merriam_monthly_pay_v2",

  save(state) {
    localStorage.setItem(this.KEY, JSON.stringify(state));
  },

  load() {
    try {
      const raw = localStorage.getItem(this.KEY);
      if (!raw) return this.createDefaultState();
      const parsed = JSON.parse(raw);
      return {
        months: parsed.months || {},
        currentMonthId: parsed.currentMonthId || null,
        bonusData: parsed.bonusData || this.createDefaultBonusData(),
      };
    } catch (e) {
      console.error("Storage load failed:", e);
      return this.createDefaultState();
    }
  },

  createDefaultState() {
    return {
      months: {},
      currentMonthId: null,
      bonusData: this.createDefaultBonusData(),
    };
  },

  createDefaultMonthData() {
    return {
      cpLabor: 0,
      cpParts: 0,
      wLabor: 0,
      wParts: 0,
      iLabor: 0,
      iParts: 0,
      subletLabor: 0,
      discounts: 0,
      hoursSold: 0,
    };
  },

  createDefaultBonusData() {
    return {
      monthLabel: "",
      monthlyCpNet: 0,
      reviewsCount: 0,
      tierEligible: "auto",
      objBase: 0,
      objMode: "weighted",
      objManualPct: 0,
      objChecks: {
        align: false,
        totLaborGross: false,
        cpLaborGross: false,
        hag: false,
        cpGrossPerRo: false,
        hoursPerCpro: false,
      },
    };
  },

  wipe() {
    localStorage.removeItem(this.KEY);
  },
};

/* ============
   STATE MANAGEMENT
============ */
const StateManager = {
  state: null,
  listeners: [],

  init() {
    this.state = Storage.load();
  },

  get() {
    return this.state || Storage.load();
  },

  update(updater) {
    this.state = updater(this.state);
    Storage.save(this.state);
    this.notify();
  },

  subscribe(callback) {
    this.listeners.push(callback);
    return () => {
      this.listeners = this.listeners.filter((l) => l !== callback);
    };
  },

  notify() {
    this.listeners.forEach((cb) => cb(this.state));
  },
};

/* ============
   UI COMPONENTS
============ */
const UI = {
  money(n) {
    return Number(n || 0).toLocaleString(undefined, {
      style: "currency",
      currency: "USD",
      minimumFractionDigits: 0,
      maximumFractionDigits: 0,
    });
  },

  moneyExact(n) {
    return Number(n || 0).toLocaleString(undefined, {
      style: "currency",
      currency: "USD",
    });
  },

  pct(n) {
    return (Number(n || 0) * 100).toFixed(1) + "%";
  },

  escape(str) {
    return String(str || "")
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;");
  },

  renderGoalProgress(cpNet) {
    const goal = Calculator.monthlyGoal;
    const pct = Math.min(100, (cpNet / goal) * 100);

    document.getElementById('goalFill').style.width = pct + '%';
    document.getElementById('goalText').textContent = `${this.money(cpNet)} / ${this.money(goal)}`;
    document.getElementById('goalPctText').textContent = pct.toFixed(0) + '%';
  },

  renderCommissionSummary(monthData) {
    const result = Calculator.calcMonthlyCommission(monthData);

    document.getElementById("kpiCpNet").textContent = this.money(result.cpNet);
    document.getElementById("kpiW").textContent = this.money(result.wSales);
    document.getElementById("kpiI").textContent = this.money(result.iSales);
    document.getElementById("kpiSublet").textContent = this.money(result.subletSales);
    document.getElementById("kpiHours").textContent = monthData.hoursSold.toFixed(1);
    document.getElementById("kpiCommission").textContent = this.moneyExact(result.commission);

    this.renderGoalProgress(result.cpNet);

    const cpComm = result.cpNet * Calculator.rates.cp;
    const wComm = result.wSales * Calculator.rates.w;
    const iComm = result.iSales * Calculator.rates.i;
    const subComm = result.subletSales * Calculator.rates.sublet;

    const breakdown = [
      ["CP (7%)", cpComm, result.cpNet],
      ["Warranty (5%)", wComm, result.wSales],
      ["Internal (5%)", iComm, result.iSales],
      ["Sublet (0.5%)", subComm, result.subletSales],
    ];

    const lines = breakdown
      .filter(([, , sales]) => sales > 0)
      .map(([name, comm, sales]) => {
        return `• <b>${name}</b>: ${this.moneyExact(comm)}`;
      })
      .join("<br>");

    document.getElementById("breakdownText").innerHTML =
      lines || "<span class='muted'>Enter monthly totals to see breakdown</span>";
  },

  renderMonthlyBonus(bonusData) {
    const bonus = Calculator.calcMonthlyBonus(bonusData);

    document.getElementById("kpiTierPct").textContent = this.pct(bonus.tier.pct);
    document.getElementById("kpiTierDollars").textContent = this.moneyExact(bonus.tier.dollars);
    document.getElementById("kpiObjPct").textContent = this.pct(bonus.obj.pct);
    document.getElementById("kpiObjDollars").textContent = this.moneyExact(bonus.obj.dollars);
    document.getElementById("kpiReviewBonus").textContent = this.moneyExact(bonus.review);
    document.getElementById("kpiTotalMonthly").textContent = this.moneyExact(bonus.total);

    const tierPill = bonus.eligible
      ? `<span class="pill" style="display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; border:1px solid var(--border); background:#0f1723; font-size:11px; color:var(--good);"><span class="dot good" style="width:8px; height:8px; border-radius:99px; background:var(--good);"></span>Tier eligible</span>`
      : `<span class="pill" style="display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; border:1px solid var(--border); background:#0f1723; font-size:11px; color:var(--bad);"><span class="dot bad" style="width:8px; height:8px; border-radius:99px; background:var(--bad);"></span>Need 7+ reviews for tier</span>`;

    const reviewPill =
      bonus.review > 0
        ? `<span class="pill" style="display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; border:1px solid var(--border); background:#0f1723; font-size:11px; color:var(--good);"><span class="dot good" style="width:8px; height:8px; border-radius:99px; background:var(--good);"></span>$375 review bonus earned!</span>`
        : `<span class="pill" style="display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; border:1px solid var(--border); background:#0f1723; font-size:11px; color:var(--warn);"><span class="dot warn" style="width:8px; height:8px; border-radius:99px; background:var(--warn);"></span>Reviews: ${bonusData.reviewsCount}/15 for $375</span>`;

    document.getElementById("monthlyStatus").innerHTML = `
      <div class="flex" style="margin-bottom:10px">${tierPill}${reviewPill}</div>
      • CP Net: <b>${this.money(bonusData.monthlyCpNet)}</b><br>
      • Objective Base: <b>${this.money(bonusData.objBase)}</b>
    `;

    // Tier breakdown
    const tierHtml = Calculator.tierLevels.map(lvl => {
      const hit = bonusData.monthlyCpNet >= lvl.threshold && bonus.eligible;
      const icon = hit ? '✓' : '○';
      const style = hit ? 'color:var(--good)' : 'color:var(--muted)';
      return `<div style="${style}">${icon} ${lvl.label} (+0.5%)</div>`;
    }).join('');

    document.getElementById("tierBreakdown").innerHTML = tierHtml || 'Hit tier levels to earn bonus %';
  },

  renderMonthsList(months, currentMonthId) {
    const monthIds = Object.keys(months).sort().reverse();

    if (monthIds.length === 0) {
      document.getElementById("monthsList").innerHTML = '<span class="muted">No saved months yet. Select a month above to get started.</span>';
      return;
    }

    const html = monthIds.map(monthId => {
      const isCurrent = monthId === currentMonthId;
      const badge = isCurrent ? '<span style="color:var(--good); font-weight:600;"> (Current)</span>' : '';
      const result = Calculator.calcMonthlyCommission(months[monthId]);
      return `• <b>${monthId}</b>${badge}: ${this.moneyExact(result.commission)}<br>`;
    }).join('');

    document.getElementById("monthsList").innerHTML = html;
  }
};

/* ============
   EVENT HANDLERS
============ */
const Events = {
  loadMonth() {
    const monthId = document.getElementById("currentMonth").value;
    if (!monthId) {
      alert("Please select a month first");
      return;
    }

    StateManager.update(state => ({
      ...state,
      currentMonthId: monthId
    }));

    const state = StateManager.get();
    const monthData = state.months[monthId] || Storage.createDefaultMonthData();

    this.hydrateMonthInputs(monthData);
    UI.renderCommissionSummary(monthData);
    UI.renderMonthsList(state.months, state.currentMonthId);
  },

  newMonth() {
    const monthId = document.getElementById("currentMonth").value;
    if (!monthId) {
      alert("Please select a month first");
      return;
    }

    const state = StateManager.get();
    if (state.months[monthId]) {
      if (!confirm(`Month ${monthId} already exists. Create a new empty month anyway?`)) {
        return;
      }
    }

    StateManager.update(state => ({
      ...state,
      months: {
        ...state.months,
        [monthId]: Storage.createDefaultMonthData()
      },
      currentMonthId: monthId
    }));

    this.hydrateMonthInputs(Storage.createDefaultMonthData());
    UI.renderCommissionSummary(Storage.createDefaultMonthData());
    UI.renderMonthsList(StateManager.get().months, monthId);

    alert(`New month ${monthId} created!`);
  },

  saveMonth() {
    const state = StateManager.get();
    const monthId = state.currentMonthId;

    if (!monthId) {
      alert("Please load or create a month first");
      return;
    }

    const monthData = {
      cpLabor: Number(document.getElementById("cpLabor").value) || 0,
      cpParts: Number(document.getElementById("cpParts").value) || 0,
      wLabor: Number(document.getElementById("wLabor").value) || 0,
      wParts: Number(document.getElementById("wParts").value) || 0,
      iLabor: Number(document.getElementById("iLabor").value) || 0,
      iParts: Number(document.getElementById("iParts").value) || 0,
      subletLabor: Number(document.getElementById("subletLabor").value) || 0,
      discounts: Number(document.getElementById("discounts").value) || 0,
      hoursSold: Number(document.getElementById("hoursSold").value) || 0,
    };

    StateManager.update(state => ({
      ...state,
      months: {
        ...state.months,
        [monthId]: monthData
      }
    }));

    UI.renderCommissionSummary(monthData);
    UI.renderMonthsList(StateManager.get().months, monthId);
  },

  clearMonth() {
    this.hydrateMonthInputs(Storage.createDefaultMonthData());
    UI.renderCommissionSummary(Storage.createDefaultMonthData());
  },

  deleteMonth() {
    const state = StateManager.get();
    const monthId = state.currentMonthId;

    if (!monthId) {
      alert("No month is currently loaded");
      return;
    }

    if (!confirm(`Delete month ${monthId}? This cannot be undone.`)) {
      return;
    }

    StateManager.update(state => {
      const newMonths = { ...state.months };
      delete newMonths[monthId];
      return {
        ...state,
        months: newMonths,
        currentMonthId: null
      };
    });

    this.clearMonth();
    UI.renderMonthsList(StateManager.get().months, null);
    alert(`Month ${monthId} deleted`);
  },

  hydrateMonthInputs(monthData) {
    document.getElementById("cpLabor").value = monthData.cpLabor || 0;
    document.getElementById("cpParts").value = monthData.cpParts || 0;
    document.getElementById("wLabor").value = monthData.wLabor || 0;
    document.getElementById("wParts").value = monthData.wParts || 0;
    document.getElementById("iLabor").value = monthData.iLabor || 0;
    document.getElementById("iParts").value = monthData.iParts || 0;
    document.getElementById("subletLabor").value = monthData.subletLabor || 0;
    document.getElementById("discounts").value = monthData.discounts || 0;
    document.getElementById("hoursSold").value = monthData.hoursSold || 0;
  },

  exportData() {
    const state = StateManager.get();
    const dataStr = JSON.stringify(state, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    const timestamp = new Date().toISOString().split('T')[0];
    link.download = `hendrick-merriam-monthly-${timestamp}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  },

  importData() {
    document.getElementById("importFile").click();
  },

  handleFileImport(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const imported = JSON.parse(e.target.result);

        if (!imported.months || typeof imported.months !== 'object') {
          alert("Invalid file format: missing months data");
          return;
        }

        if (confirm("This will replace all current data. Continue?")) {
          StateManager.update(() => ({
            months: imported.months || {},
            currentMonthId: imported.currentMonthId || null,
            bonusData: imported.bonusData || Storage.createDefaultBonusData(),
          }));
          alert("Data imported successfully!");

          // Reload current month if set
          if (imported.currentMonthId) {
            document.getElementById("currentMonth").value = imported.currentMonthId;
            this.loadMonth();
          }
        }
      } catch (err) {
        alert("Failed to import: " + err.message);
      }
    };
    reader.readAsText(file);
    event.target.value = '';
  },

  saveMonthlyBonus() {
    const bonusData = {
      monthLabel: document.getElementById("monthLabel").value,
      monthlyCpNet: Number(document.getElementById("monthlyCpNet").value) || 0,
      reviewsCount: Number(document.getElementById("reviewsCount").value) || 0,
      tierEligible: document.getElementById("tierEligible").value,
      objBase: Number(document.getElementById("objBase").value) || 0,
      objMode: document.getElementById("objMode").value,
      objManualPct: Number(document.getElementById("objManualPct").value) || 0,
      objChecks: {
        align: document.getElementById("objAlign").checked,
        totLaborGross: document.getElementById("objTotLaborGross").checked,
        cpLaborGross: document.getElementById("objCpLaborGross").checked,
        hag: document.getElementById("objHag").checked,
        cpGrossPerRo: document.getElementById("objCpGrossPerRo").checked,
        hoursPerCpro: document.getElementById("objHoursPerCpro").checked,
      },
    };

    StateManager.update(state => ({
      ...state,
      bonusData
    }));

    alert("Monthly bonus inputs saved!");
  },

  resetMonthly() {
    if (!confirm("Reset monthly bonus inputs?")) return;

    StateManager.update(state => ({
      ...state,
      bonusData: Storage.createDefaultBonusData()
    }));

    this.hydrateBonusInputs();
  },

  wipeAll() {
    if (!confirm("This will delete ALL data. Are you sure?")) return;

    StateManager.update(() => Storage.createDefaultState());
    this.clearMonth();
    UI.renderMonthsList({}, null);
  },

  hydrateBonusInputs() {
    const b = StateManager.get().bonusData;
    document.getElementById("monthLabel").value = b.monthLabel || "";
    document.getElementById("monthlyCpNet").value = b.monthlyCpNet || 0;
    document.getElementById("reviewsCount").value = b.reviewsCount || 0;
    document.getElementById("tierEligible").value = b.tierEligible || "auto";
    document.getElementById("objBase").value = b.objBase || 0;
    document.getElementById("objMode").value = b.objMode || "weighted";
    document.getElementById("objManualPct").value = b.objManualPct || 0;

    const c = b.objChecks || {};
    document.getElementById("objAlign").checked = !!c.align;
    document.getElementById("objTotLaborGross").checked = !!c.totLaborGross;
    document.getElementById("objCpLaborGross").checked = !!c.cpLaborGross;
    document.getElementById("objHag").checked = !!c.hag;
    document.getElementById("objCpGrossPerRo").checked = !!c.cpGrossPerRo;
    document.getElementById("objHoursPerCpro").checked = !!c.hoursPerCpro;

    this.updateObjModeUI();
  },

  updateObjModeUI() {
    const mode = document.getElementById("objMode").value;
    document.getElementById("objWeighted").classList.toggle("hide", mode !== "weighted");
    document.getElementById("objManual").classList.toggle("hide", mode !== "manual");
  },
};

/* ============
   TABS
============ */
const tabDefs = [
  { id: "commissions", label: "Monthly Pay" },
  { id: "bonuses", label: "Monthly Bonuses" },
];

const tabsEl = document.getElementById("tabs");
tabDefs.forEach((t) => {
  const b = document.createElement("button");
  b.className = "tab";
  b.textContent = t.label;
  b.dataset.target = t.id;
  b.addEventListener("click", () => showTab(t.id));
  tabsEl.appendChild(b);
});

function showTab(id) {
  document.querySelectorAll(".tabPage").forEach((p) => {
    p.classList.toggle("hide", p.dataset.page !== id);
  });
  document.querySelectorAll(".tab").forEach((b) => {
    b.classList.toggle("active", b.dataset.target === id);
  });

  if (id === "bonuses") {
    Events.hydrateBonusInputs();
  }
}

/* ============
   INIT
============ */
function init() {
  // Initialize storage
  StateManager.init();

  // Set current month as default
  const now = new Date();
  const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
  document.getElementById("currentMonth").value = currentMonth;

  // Wire up event handlers
  document.getElementById("loadMonth").addEventListener("click", () => Events.loadMonth());
  document.getElementById("newMonth").addEventListener("click", () => Events.newMonth());
  document.getElementById("saveMonth").addEventListener("click", () => Events.saveMonth());
  document.getElementById("clearMonth").addEventListener("click", () => Events.clearMonth());
  document.getElementById("deleteMonth").addEventListener("click", () => Events.deleteMonth());
  document.getElementById("exportData").addEventListener("click", () => Events.exportData());
  document.getElementById("importData").addEventListener("click", () => Events.importData());
  document.getElementById("importFile").addEventListener("change", (e) => Events.handleFileImport(e));
  document.getElementById("saveMonthlyBonus").addEventListener("click", () => Events.saveMonthlyBonus());
  document.getElementById("resetMonthly").addEventListener("click", () => Events.resetMonthly());
  document.getElementById("wipeAll").addEventListener("click", () => Events.wipeAll());

  // Auto-save on input changes
  ["cpLabor", "cpParts", "wLabor", "wParts", "iLabor", "iParts", "subletLabor", "discounts", "hoursSold"].forEach(id => {
    document.getElementById(id).addEventListener("input", () => {
      const state = StateManager.get();
      if (state.currentMonthId) {
        Events.saveMonth();
      }
    });
  });

  // Obj mode toggle
  document.getElementById("objMode").addEventListener("change", () => {
    Events.updateObjModeUI();
    UI.renderMonthlyBonus(StateManager.get().bonusData);
  });

  // Live updates for monthly bonus
  ["monthLabel", "monthlyCpNet", "reviewsCount", "tierEligible", "objBase", "objManualPct"].forEach((id) => {
    document.getElementById(id).addEventListener("input", () => {
      UI.renderMonthlyBonus(StateManager.get().bonusData);
    });
  });

  ["objAlign", "objTotLaborGross", "objCpLaborGross", "objHag", "objCpGrossPerRo", "objHoursPerCpro"].forEach((id) => {
    document.getElementById(id).addEventListener("change", () => {
      UI.renderMonthlyBonus(StateManager.get().bonusData);
    });
  });

  // Subscribe to state changes
  StateManager.subscribe((state) => {
    const monthData = state.currentMonthId && state.months[state.currentMonthId]
      ? state.months[state.currentMonthId]
      : Storage.createDefaultMonthData();

    UI.renderCommissionSummary(monthData);
    UI.renderMonthlyBonus(state.bonusData);
    UI.renderMonthsList(state.months, state.currentMonthId);
  });

  // Initial render
  const state = StateManager.get();
  const monthData = state.currentMonthId && state.months[state.currentMonthId]
    ? state.months[state.currentMonthId]
    : Storage.createDefaultMonthData();

  UI.renderCommissionSummary(monthData);
  UI.renderMonthlyBonus(state.bonusData);
  UI.renderMonthsList(state.months, state.currentMonthId);
  showTab("commissions");

  // Try to load current month if exists
  if (state.months[currentMonth]) {
    StateManager.update(s => ({ ...s, currentMonthId: currentMonth }));
    Events.hydrateMonthInputs(state.months[currentMonth]);
  }
}

init();
</script>
</body>
</html>
